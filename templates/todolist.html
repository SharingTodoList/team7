{% extends 'basic.html' %}
{% block content %}

<style>
  .tableclass {
    display: block;
    margin: 0px auto;
    text-align: center;
    max-width: 700px;
    width: 95%;
  }
</style>

<script>
  $(document).ready(function () {
    show_bucket();
  });

  function show_bucket() {

    $.ajax({
      type: "POST",
      url: "/bucketlist",
      data: {},
      success: function (response) {
        let rows = response['buckets'];
        for (let i = 0; i < rows.length; i++) {
          let detail = rows[i]['detail'];
          let seq = rows[i]['seq'];
          let status = rows[i]['status'];
          let date = rows[i]['date'];
          let time = rows[i]['time'];
          let temp_html = ``;

            debugger
          if (status == 0) {
            temp_html = `<tr>
                              <td>
                                ${time}
                              </td>
                              <td>
                                ${detail}

                              </td>
                              <td>
                                <button onclick="done_bucket(${seq})" type="button" class="btn btn-outline-primary">완료!</button>
                                <button onclick="delete_bucket(${seq})" type="button" class="btn btn-outline-primary">삭제</button>
                              </td>
                            </tr>`;
          } else {
            temp_html = `<tr>
                <td>
                  <h2>${time}</h2>
                </td>
                <td>
                  <h2>${detail}</h2>

                </td>
                <td>
                  <button onclick="back_bucket(${seq})" type="button" class="btn btn-outline-primary">취소!</button>
                  <button onclick="delete_bucket(${seq})" type="button" class="btn btn-outline-primary">삭제</button>
                </td>
              </tr>`;
          }

          $("#tbody").append(temp_html);

        }
      },
    });
  }


  function save_bucket() {
    let bucket = $('#bucket').val();
    let time = $('#time_from').val();

    $.ajax({
      type: "POST",
      url: "/bucket",
      data: { bucket_give: bucket, time_give: time },
      success: function (response) {
        alert(response["msg"]);
        window.location.reload();
      },
    });
  }

  function done_bucket(seq) {
    $.ajax({
      type: "POST",
      url: "/bucket/done",
      data: { seq_give: seq },
      success: function (response) {
        alert(response["msg"]);
        window.location.reload();
      },
    });
  }

  function back_bucket(seq) {
    $.ajax({
      type: "POST",
      url: "/bucket/back",
      data: { seq_give: seq },
      success: function (response) {
        alert(response["msg"]);
        window.location.reload();
      },
    });
  }

  function delete_bucket(seq) {
    $.ajax({
      type: "POST",
      url: "/bucket/delete",
      data: { seq_give: seq },
      success: function (response) {
        alert(response["msg"]);
        window.location.reload();
      },
    });
  }

  $(document).ready(function () {
    var tag = {};
    var counter = 0;

    // 입력한 값을 태그로 생성한다.
    function addTag(value) {
      tag[counter] = value;
      counter++; // del-btn 의 고유 id 가 된다.
    }

    // tag 안에 있는 값을 array type 으로 만들어서 넘긴다.
    function marginTag() {
      return Object.values(tag).filter(function (word) {
        return word !== "";
      });
    }

    // 서버에 제공
    $("#tag-form").on("submit", function (e) {
      var value = marginTag(); // return array
      $("#rdTag").val(value);

      $(this).submit();
    });

    function addTagData(tagValue) {
      $.ajax({
        type: "POST",
        url: "/bucket",
        data: { tag_give: tagValue },
      });
    }

    $("#tag").on("keypress", function (e) {
      var self = $(this);

      //엔터나 스페이스바 눌렀을때 실행
      if (e.key === "Enter" || e.keyCode == 32) {

        var tagValue = self.val(); // 값 가져오기

        // 해시태그 값 없으면 실행X
        if (tagValue !== "") {

          // 같은 태그가 있는지 검사한다. 있다면 해당값이 array 로 return 된다.
          var result = Object.values(tag).filter(function (word) {
            return word === tagValue;
          })

          // 해시태그가 중복되었는지 확인
          if (result.length == 0) {
            $("#tag-list").append("<li class='tag-item'>" + tagValue + "<span class='del-btn' idx='" + counter + "'>x</span></li>");
            addTag(tagValue);
            addTagData(tagValue);
            self.val("");
          } else {
            alert("태그값이 중복됩니다.");
          }
        }
        e.preventDefault(); // SpaceBar 시 빈공간이 생기지 않도록 방지
      }
    });

    // 삭제 버튼
    // 인덱스 검사 후 삭제
    $(document).on("click", ".del-btn", function (e) {
      var index = $(this).attr("idx");
      tag[index] = "";
      $(this).parent().remove();
    });
  })



</script>


<body>


  <div class="mybox">
    <div class="mybucket">
      할일 : &nbsp;<input id="bucket" class="form-control" type="text" placeholder="할일을 입력하세요" />
    </div>
    <br>
    <br>
    <div class="mytime">
      시간대 : &nbsp;
      <select id="time_from" onchange="s_time_select(this)" class="time_select">
        <script>
          for (i = 12; i < 48; i++) {
            var hour = "";
            var min = ":00";

            if (Math.ceil(i / 2) < 13) {
              hour = Math.floor(i / 2);
            } else {
              hour = Math.floor(i / 2);
            }
            if (i % 2 != 0) {
              min = ":30";
            }
            document.write(
              "<option value=" + hour + min + ">" + hour + min + "</option>"
            );
          }
        </script>
      </select>
      &nbsp;&nbsp;~ &nbsp; &nbsp;
      <select id="time_to" onchange="s_time_select(this)" class="time_select">
        <script>
          for (i = 12; i < 48; i++) {
            var hour = "";
            var min = ":00";

            if (Math.ceil(i / 2) < 13) {
              hour = Math.floor(i / 2);
            } else {
              hour = Math.floor(i / 2);
            }
            if (i % 2 != 0) {
              min = ":30";
            }
            document.write(
              "<option value=" + hour + min + ">" + hour + min + "</option>"
            );
          }
        </script>
      </select>

      &nbsp;&nbsp;<input type="checkbox" name="no-time" value="no-time" />시간대 선택 안함
    </div>
    <br>
    <br>
{#    <div class="tr_hashTag_area">#}
{#      <p><strong>태그 추가하기</strong></p>#}
{#      <div class="form-group">#}
{#        <input type="hidden" value="" name="tag" id="rdTag" />#}
{#      </div>#}

{#      <ul id="tag-list"></ul>#}
{##}
{#      <div class="form-group">#}
{#        <input type="text" id="tag" size="7" placeholder="엔터로 해시태그를 등록해주세요." style="width: 300px;" />#}
{#      </div>#}
{#    </div>#}

    <button onclick="save_bucket()" type="button" class="btn btn-outline-primary">
      (+)
    </button>
  </div>


  <div class="tableclass">
    <table class="table table-success table-striped">
      <thead>
        <tr>
          <th scope="col">시간</th>
          <th scope="col">내용</th>

          <th scope="col">완료여부</th>
        </tr>
      </thead>
      <tbody id="tbody">

      </tbody>
    </table>
  </div>


  {% endblock %}